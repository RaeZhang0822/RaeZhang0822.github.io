<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"raezhang0822.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.17.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"style":null,"show_result":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Welcome">
<meta property="og:url" content="https://raezhang0822.github.io/index.html">
<meta property="og:site_name" content="Welcome">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Rae Zhang">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://raezhang0822.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Welcome</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Welcome</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives<span class="badge">5</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rae Zhang</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">5</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/raezhang0822" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;raezhang0822" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:mingruizhang0822@gmail.com" title="E-Mail → mailto:mingruizhang0822@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>
  <div class="cc-license animated" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="https://cdnjs.cloudflare.com/ajax/libs/creativecommons-vocabulary/2020.11.3/assets/license_badges/small/by_nc_sa.svg" alt="Creative Commons"></a>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://raezhang0822.github.io/2023/07/05/formRender/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rae Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Welcome">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/05/formRender/" class="post-title-link" itemprop="url">React前端表单解决方案对比</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-05 16:46:21" itemprop="dateCreated datePublished" datetime="2023-07-05T16:46:21+00:00">2023-07-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>渠道对接需要编写大量重复职位信息的表单，所以自己用类似 JSON Schema 的规则写了一套表单渲染逻辑，完成之后对业务提升效果很大。回看最初的方案调研阶段，发现除了 Formily,有很多其他的成熟的开源方案可以借鉴，所以总结一下。<br>业务场景核心诉求：</p>
<ol>
<li>具备远程动态渲染能力。也就是支持根据配置动态渲染表单 ，这是硬性条件。</li>
<li>支持完善的动态逻辑表达能力。<br>在 表单配置 层面，能够完善的应对一些联动及动态校验场景。并且最好拥有一些底线思维，比如提供的动态语法一旦不满足要求，可以直接手写字符串的 js function（最好解决作用域的问题）。</li>
<li>拥有完善的自定义能力。因为需要使用内部 UI 组件实现。</li>
<li>有处理异步数据源的能力。比如一个下拉选项，可选项需要从后端异步拉取，这是非常常见的需求。但如何让一个静态的 JSON 表达异步请求，是一个难点。</li>
</ol>
<h2 id="常见方案分析"><a href="#常见方案分析" class="headerlink" title="常见方案分析"></a>常见方案分析</h2><p><em>社区支持度数据截止是本文编辑时 （2023.07.05）,最新社区数据需要自行前往 github 确认</em></p>
<blockquote>
<p>Formily 是阿里开源的动态化表单的解决方案，优雅的解决了多种复杂场景的表单的数据、状态管理及夸表单通信问题，同时规避了全量全然的弊端，性能优越，生态完备</p>
</blockquote>
<blockquote>
<p>XRender 是一套基于 React.js 框架的，轻量、易用、易上手的中后台「表单 &#x2F; 表格 &#x2F; 图表」解决方案</p>
</blockquote>
<blockquote>
<p>Formik 是一个流行的 React 表单库，它提供了一个简单但功能强大的 API 来处理表单状态和验证。Formik 支持多种输入控件类型和验证规则，并且可以自定义表单布局和提交行为。</p>
</blockquote>
<blockquote>
<p>React Hook Form 是另一个流行的 React 表单库，它采用 Hook API 来处理表单状态和验证。React Hook Form 专注于性能和易用性，可以处理大量的表单数据，并提供了一系列方便的工具和组件来构建表单。</p>
</blockquote>
<h2 id="Formily"><a href="#Formily" class="headerlink" title="Formily"></a>Formily</h2><h3 id="社区支持度"><a href="#社区支持度" class="headerlink" title="社区支持度"></a>社区支持度</h3><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/x-render">github star</a>: 9.8K</p>
<h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>功能丰富：提供了非常丰富的功能，包括表单状态管理、表单验证、表单布局、表单联动等。而且 Formily 的功能非常灵活，可以满足各种不同的表单需求。</li>
<li>性能优秀：性能非常出色，它采用了一些优化策略来提高表单渲染和处理的效率，例如虚拟滚动、异步渲染、缓存等。</li>
<li>扩展性强：提供了非常灵活的扩展接口，开发者可以通过插件、中间件、渲染器等方式来扩展 Formily 的功能。</li>
<li>生态完备：生态圈非常完备，包括了大量的插件、工具、组件等，可以满足各种不同的表单需求。</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>依赖较多，整体体积较大，压缩前 130k，压缩后 80k，包含桥接组件库</li>
<li>学习成本较高，文档不够完善</li>
</ul>
<p>这里附上一个 Formily 官方的 <a target="_blank" rel="noopener" href="https://v2.formilyjs.org/zh-CN/guide#%E7%AB%9E%E5%93%81%E5%AF%B9%E6%AF%94">竞品对比</a></p>
<h2 id="XRender"><a href="#XRender" class="headerlink" title="XRender"></a>XRender</h2><h3 id="社区支持度-1"><a href="#社区支持度-1" class="headerlink" title="社区支持度"></a>社区支持度</h3><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/x-render">github star</a>: 6.2K</p>
<h3 id="优点-："><a href="#优点-：" class="headerlink" title="优点 ："></a>优点 ：</h3><ul>
<li>高性能：XRender 使用 GPU 加速技术，能够快速渲染复杂的表单界面，提高表单的渲染效率和用户体验。<br>可扩展性：XRender 提供了可扩展的组件和插件机制，支持自定义组件和表单校验规则，方便用户根据具体需求进行扩展和定制。</li>
<li>灵活性：XRender 提供了丰富的表单控件和布局方式，支持多种数据格式和表单交互方式，具有较高的灵活性。提供的 (playground)[<a target="_blank" rel="noopener" href="https://xrender.fun/playground]">https://xrender.fun/playground]</a> 工具可以方便用来边写边看表单效果。</li>
<li>兼容性：XRender 兼容性良好，能够支持大多数主流浏览器和操作系统，同时也能够支持移动设备。</li>
</ul>
<h3 id="缺点-1"><a href="#缺点-1" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>不支持动态数据拉取</li>
<li>依赖较多：XRender 依赖于许多其他的前端框架和库，如 React、Vue、Ant Design 等，使用时需要引入相应的依赖和资源。</li>
</ul>
<h2 id="Formik-React-官方推荐"><a href="#Formik-React-官方推荐" class="headerlink" title="Formik(React 官方推荐)"></a>Formik(React 官方推荐)</h2><h3 id="社区支持度-2"><a href="#社区支持度-2" class="headerlink" title="社区支持度"></a>社区支持度</h3><p><a target="_blank" rel="noopener" href="https://github.com/jaredpalmer/formik">github star</a>: 32.6K</p>
<p>React <a target="_blank" rel="noopener" href="https://zh-hans.legacy.reactjs.org/docs/forms.html">官方推荐</a><br><img src="/./img/formRender/formik.png" alt="image"></p>
<h3 id="优点-1"><a href="#优点-1" class="headerlink" title="优点"></a>优点</h3><ul>
<li>简单易用：提供了简洁易懂的 API，使得表单处理变得更加容易。</li>
<li>具有可扩展性：提供了灵活的插件系统，可以通过插件来扩展其功能，例如使用 Yup 插件进行表单验证。</li>
<li>与 React 无缝集成：完全基于 React，可以与 React 的生命周期方法和状态管理库（如 Redux）无缝集成，方便开发者进行开发。</li>
<li>高性能：采用了优化的渲染策略，仅在需要时才更新表单的组件，从而提高了性能。</li>
</ul>
<h3 id="缺点："><a href="#缺点：" class="headerlink" title="缺点："></a>缺点：</h3><ul>
<li>issue 中 bug 较多</li>
<li>表单样式需要自己处理：Formik 只提供了表单处理逻辑，不包含任何样式，需要自行添加样式，不过也正好适合自定义 ui 的情况</li>
</ul>
<h2 id="React-Hook-Form"><a href="#React-Hook-Form" class="headerlink" title="React Hook Form"></a>React Hook Form</h2><h3 id="社区支持"><a href="#社区支持" class="headerlink" title="社区支持"></a>社区支持</h3><p><a target="_blank" rel="noopener" href="https://github.com/react-hook-form/react-hook-form">github stars</a>: 35.7K</p>
<h3 id="优点-2"><a href="#优点-2" class="headerlink" title="优点"></a>优点</h3><ul>
<li>足够轻量，以及使用 ref 保存值的特点，使它在性能敏感的场景有足够的吸引力。</li>
<li>对非受控组件的场景支持很好。</li>
<li>为动态变化的表单项提供了 custom-hooks，简洁的 API 帮助开发者应对复杂的场景。</li>
<li>强大的类型支持。</li>
<li>友善的社区和快速的支持。</li>
<li>支持多种表单校验方式。</li>
</ul>
<h3 id="缺点-2"><a href="#缺点-2" class="headerlink" title="缺点"></a>缺点</h3><p>和 Formik 类似，不包含任意样式，某种程度上也是优点，支持自定义 UI。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>Formik 和 react-hook-form 更多是处理表单的性能和校验问题，并不是原生就支持 json-schema。所以并不适配业务场景。</p>
<p>Formily 和 XRender 二者都支持 json-schema。<br>Formily 功能全面，但体积更大，接自定义 UI 组件成本高，学习成本也高；<br>x-render 本身附带的有一个开源的表单编辑器。已经集成了物料拖拽等基础交互，所以，整体的表单编辑器可以基于它进行二次开发。渲染器这部分, 可以利用它易用的自定义组件能力整体将内置组件封装一层异步逻辑去支持缺失的异步数据源等功能，扩展性会比较强。这个 <a target="_blank" rel="noopener" href="https://github.com/alibaba/x-render/issues/94">x-render 实际应用集合</a>里有一些比较成熟线上例子。</p>
<p>总体来看，如果不是自己造轮子的话，XRender 更适合当前业务场景的需求。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>虽然自己造轮子解决了类似的表单场景，但通过调研开源方案发现了自己的轮子缺失的部分，比如我使用了自己定义的表单字段规则而不是标准的 JSON Schema 对象，优点是联动和校验相比标准 json-schema 都要简单一些，缺点则是无法借助 ajv 等工具对配置对象进行有效性检测，只能全部依赖于人工测试。</p>
<p>如果能重来，我应该会选 标准 JSON Schema 方便自动检测、后期维护和迁移。表单渲染器部分还是会自己实现，因为需要使用内部的 UI 组件，而且需要异步获取数据，这两项对 XRender 的二次开发成本和自己实现一个简单的表单渲染器实际可能差不多，相比较之下，内部实现的代码更好维护一些。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7207964899381018661">React 前端表单解决方案</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/billyu/p/13792908.html">Redux-form vs formik vs react-hook-form</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://raezhang0822.github.io/2023/07/05/browserCache/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rae Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Welcome">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/05/browserCache/" class="post-title-link" itemprop="url">浏览器缓存机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-05 06:31:53" itemprop="dateCreated datePublished" datetime="2023-07-05T06:31:53+00:00">2023-07-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><small>原文发布于 <a target="_blank" rel="noopener" href="https://blog.csdn.net/RaeZhang/article/details/117528885">CSDN</a>，本文系近期迁移，想看更多欢迎访问 <a target="_blank" rel="noopener" href="https://blog.csdn.net/RaeZhang?type=blog">我的 CSDN 主页</a></small></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一个优秀的缓存策略可以缩短网页请求资源的距离，减少延迟，并且由于缓存文件可以重复利用，还可以减少带宽，降低网络负荷。<br> <br> 对于一个数据请求来说，可以分为发起<strong>网络请求</strong>、<strong>后端处理</strong>、<strong>浏览器响应</strong>三个步骤。<br> <br>浏览器缓存可以帮助我们在第一和第三步骤中优化性能:比如说直接使用缓存而不发起请求，或者发起了请求但后端存储的数据和前端一致，那么就没有必要再将数据回传回来，这样就减少了响应数据。</p>
<h1 id="缓存位置"><a href="#缓存位置" class="headerlink" title="缓存位置"></a>缓存位置</h1><p>浏览器缓存共有四种，且有一定的优先级，当所有缓存都没有命中时才回去进行网络请求。</p>
<ol>
<li>Service Worker</li>
<li>Memory Cache</li>
<li>Disk Cache</li>
<li>Push Cache</li>
</ol>
<h2 id="Service-Worker"><a href="#Service-Worker" class="headerlink" title="Service Worker"></a>Service Worker</h2><p>Service Worker 是运行在浏览器背后的独立线程，一般可以用来实现缓存功能。使用 Service Worker 的话，传输协议必须为 HTTPS。因为 Service Worker 中涉及到请求拦截，所以必须使用 HTTPS 协议来保障安全。Service Worker 的缓存与浏览器其他内建的缓存机制不同，它可以让我们自由控制缓存哪些文件、如何匹配缓存、如何读取缓存，并且缓存是持续性的。</p>
<ol>
<li>注册 Service worker :在你的 index.html 加入以下内容</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 判断当前浏览器是否支持serviceWorker */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="string">&quot;serviceWorker&quot;</span> <span class="keyword">in</span> navigator) &#123;</span><br><span class="line">  <span class="comment">/* 当页面加载完成就创建一个serviceWorker */</span></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;load&quot;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">/* 创建并指定对应的执行内容 */</span></span><br><span class="line">    <span class="comment">/* scope 参数是可选的，可以用来指定你想让 service worker 控制的内容的子目录。 在这个例子里，我们指定了 &#x27;/&#x27;，表示 根网域下的所有内容。这也是默认值。 */</span></span><br><span class="line">    navigator.<span class="property">serviceWorker</span></span><br><span class="line">      .<span class="title function_">register</span>(<span class="string">&quot;./serviceWorker.js&quot;</span>, &#123; <span class="attr">scope</span>: <span class="string">&quot;./&quot;</span> &#125;)</span><br><span class="line">      .<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">registration</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(</span><br><span class="line">          <span class="string">&quot;ServiceWorker registration successful with scope: &quot;</span>,</span><br><span class="line">          registration.<span class="property">scope</span></span><br><span class="line">        );</span><br><span class="line">      &#125;)</span><br><span class="line">      .<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ServiceWorker registration failed: &quot;</span>, err);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.安装 worker：在我们指定的处理程序 serviceWorker.js 中书写对应的安装及拦截逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 监听安装事件，install 事件一般是被用来设置你的浏览器的离线缓存逻辑 */</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;install&quot;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="comment">/* 通过这个方法可以防止缓存未完成，就关闭serviceWorker */</span></span><br><span class="line">  event.<span class="title function_">waitUntil</span>(</span><br><span class="line">    <span class="comment">/* 创建一个名叫V1的缓存版本 */</span></span><br><span class="line">    caches.<span class="title function_">open</span>(<span class="string">&quot;v1&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">cache</span>) &#123;</span><br><span class="line">      <span class="comment">/* 指定要缓存的内容，地址为相对于跟域名的访问路径 */</span></span><br><span class="line">      <span class="keyword">return</span> cache.<span class="title function_">addAll</span>([<span class="string">&quot;./index.html&quot;</span>]);</span><br><span class="line">    &#125;)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 注册fetch事件，拦截全站的请求 */</span></span><br><span class="line"><span class="variable language_">this</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;fetch&quot;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  event.<span class="title function_">respondWith</span>(</span><br><span class="line">    <span class="comment">// magic goes here</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 在缓存中匹配对应请求资源直接返回 */</span></span><br><span class="line">    caches.<span class="title function_">match</span>(event.<span class="property">request</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>当 Service Worker 没有命中缓存的时候，我们需要去调用 fetch 函数获取数据。也就是说，如果我们没有在 Service Worker 命中缓存的话，会根据缓存查找优先级去查找数据。但是不管我们是从 Memory Cache 中还是从网络请求中获取的数据，浏览器都会显示我们是从 Service Worker 中获取的内容。</p>
<h2 id="Memory-Cache"><a href="#Memory-Cache" class="headerlink" title="Memory Cache"></a>Memory Cache</h2><p>Memory Cache 也就是内存中的缓存</p>
<p>优点：读取速度快</p>
<p>缺点：一旦我们关闭 Tab 页面，内存中的缓存也就被释放了。<br>当我们访问过页面以后，再次刷新页面，可以发现很多数据都来自于内存缓存</p>
<p>当我们刷新一个已经打开的页面，通常可以看到许多 memory cache 的资源。<br><img src="/./img/browserCache/memoryCache.png" alt="image"></p>
<h2 id="Disk-Cache"><a href="#Disk-Cache" class="headerlink" title="Disk Cache"></a>Disk Cache</h2><p>Disk Cache 也就是存储在硬盘中的缓存，读取速度慢点，但是什么都能存储到磁盘中，比之 Memory Cache 胜在容量和存储时效性上。</p>
<p>在所有浏览器缓存中，Disk Cache 覆盖面基本是最大的。它会根据 HTTP Herder 中的字段判断哪些资源需要缓存，哪些资源可以不请求直接使用，哪些资源已经过期需要重新请求。并且即使在跨站点的情况下，相同地址的资源一旦被硬盘缓存下来，就不会再次去请求数据。绝大部分的缓存都来自 Disk Cache，关于 HTTP 的协议头中的缓存字段，我们会在下文进行详细介绍。</p>
<p>浏览器会把哪些文件丢进内存中？哪些丢进硬盘中？<br>关于这点，网上说法不一，不过以下观点比较靠得住：</p>
<p>对于大文件来说，大概率是不存储在内存中的，反之优先<br>当前系统内存使用率高的话，文件优先存储进硬盘</p>
<h2 id="Push-Cache"><a href="#Push-Cache" class="headerlink" title="Push Cache"></a>Push Cache</h2><p>Push Cache（推送缓存）是 HTTP&#x2F;2 中的内容，当以上三种缓存都没有命中时，它才会被使用。它只在会话（Session）中存在，一旦会话结束就被释放，并且缓存时间也很短暂，在 Chrome 浏览器中只有 5 分钟左右，同时它也并非严格执行 HTTP 头中的缓存指令。</p>
<p>浏览器可以拒绝接受已经存在的资源推送<br>你可以给其他域名推送资源<br>如果以上四种缓存都没有命中的话，那么只能发起请求来获取资源了。</p>
<h1 id="缓存过程分析"><a href="#缓存过程分析" class="headerlink" title="缓存过程分析"></a>缓存过程分析</h1><p><img src="/./img/browserCache/cacheProcess.png" alt="image"><br>根据是否需要向服务器重新发起 HTTP 请求将缓存过程分为两个部分，分别是强缓存和协商缓存。</p>
<h1 id="强缓存"><a href="#强缓存" class="headerlink" title="强缓存"></a>强缓存</h1><p>不会向服务器发送请求，直接从缓存中读取资源。</p>
<p>在 chrome 控制台的 Network 选项中可以看到该请求返回 200 的状态码，并且 Size 显示<strong>from disk cache</strong>或<strong>from memory cache</strong>。<br>如<br><img src="/./img/browserCache/memoryCacheExample.png" alt="image"></p>
<p>强缓存可以通过设置两种 HTTP Header 实现：Expires 和 Cache-Control。</p>
<ol>
<li><p>Expires<br>缓存过期时间，用来指定资源到期的时间，是服务器端的具体的时间点。</p>
</li>
<li><p>Cache-Control<br>比如：Cache-Control:max-age&#x3D;300 时，则代表在这个请求正确返回的 5 分钟内再次加载资源，就会命中强缓存。<br><img src="/./img/browserCache/cacheControlExample.png" alt="image"></p>
</li>
</ol>
<h2 id="Expires-和-Cache-Control-的差别"><a href="#Expires-和-Cache-Control-的差别" class="headerlink" title="Expires 和 Cache-Control 的差别"></a>Expires 和 Cache-Control 的差别</h2><p>其实这两者差别不大，区别就在于 Expires 是 http1.0 的产物，Cache-Control 是 http1.1 的产物，两者同时存在的话，Cache-Control 优先级高于 Expires；在某些不支持 HTTP1.1 的环境下，Expires 就会发挥用处。所以 Expires 其实是过时的产物，现阶段它的存在只是一种兼容性的写法。</p>
<p>强缓存判断是否缓存的依据来自于是否超出某个时间或者某个时间段，而不关心服务器端文件是否已经更新，这可能会导致加载文件不是服务器端最新的内容，那我们如何获知服务器端内容是否已经发生了更新呢？此时我们需要用到协商缓存策略。</p>
<h1 id="协商缓存"><a href="#协商缓存" class="headerlink" title="协商缓存"></a>协商缓存</h1><p>协商缓存就是强制缓存失效后，浏览器携带缓存标识向服务器发起请求，由服务器根据缓存标识决定是否使用缓存的过程。<br>协商缓存可以通过设置两种 HTTP Header 实现：Last-Modified 和 ETag 。</p>
<h2 id="Last-Modified-和-If-Modified-Since"><a href="#Last-Modified-和-If-Modified-Since" class="headerlink" title="Last-Modified 和 If-Modified-Since"></a>Last-Modified 和 If-Modified-Since</h2><p>Last-Modified 指的是这个资源在服务器上的最后修改时间，<br>浏览器下一次请求这个资源，浏览器检测到有 Last-Modified 这个 header，于是添加 If-Modified-Since 这个 header，值就是 Last-Modified 中的值；服务器再次收到这个资源请求，会根据 If-Modified-Since 中的值与服务器中这个资源的最后修改时间对比，如果没有变化，返回 304 和空的响应体，直接从缓存读取<br><img src="/./img/browserCache/negotiationCacheProcess.png" alt="image"></p>
<p>如下面这个请求：<br>request headers 中有 if-modified-since,表明浏览器之前请求过这个资源<br><img src="/./img/browserCache/negotiationCacheExample.png" alt="image"><br>response headers 返回状态 304,表明协商缓存成功，last-modified 与请求头中的 if-modified-since 一致。<br><img src="/./img/browserCache/negotiationCacheExample2.png" alt="image"></p>
<p>如果 If-Modified-Since 的时间小于服务器中这个资源的最后修改时间，说明文件有更新，协商缓存失效，返回 200 和请求结果<br><img src="/./img/browserCache/withoutCacheProcess.png" alt="image"></p>
<h3 id="弊端："><a href="#弊端：" class="headerlink" title="弊端："></a>弊端：</h3><p>如果本地打开缓存文件，即使没有对文件进行修改，但还是会造成 Last-Modified 被修改，服务端不能命中缓存导致发送相同的资源。</p>
<p>因为 Last-Modified 只能以秒计时，如果在不可感知的时间内修改完成文件，那么服务端会认为资源还是命中了，不会返回正确的资源。</p>
<p>既然根据文件修改时间来决定是否缓存尚有不足，能否可以直接根据文件内容是否修改来决定缓存策略？所以在 HTTP &#x2F; 1.1 出现了 ETag 和 If-None-Match</p>
<h2 id="ETag-和-If-None-Match"><a href="#ETag-和-If-None-Match" class="headerlink" title="ETag 和 If-None-Match"></a>ETag 和 If-None-Match</h2><p>Etag 是服务器响应请求时，返回当前资源文件的一个唯一标识(由服务器生成)，只要资源有变化，Etag 就会重新生成。<br>浏览器在下一次加载资源向服务器发送请求时，会将上一次返回的 Etag 值放到 request header 里的 If-None-Match 里，服务器只需要比较客户端传来的 If-None-Match 跟自己服务器上该资源的 ETag 是否一致，就能很好地判断资源相对客户端而言是否被修改过了。如果服务器发现 ETag 匹配不上，那么直接以常规 GET 200 回包形式将新的资源（当然也包括了新的 ETag）发给客户端；如果 ETag 是一致的，则直接返回 304 知会客户端直接使用本地缓存即可。</p>
<p><img src="/./img/browserCache/EtagProcess.png" alt="image"></p>
<h2 id="协商缓存的两者对比"><a href="#协商缓存的两者对比" class="headerlink" title="协商缓存的两者对比"></a>协商缓存的两者对比</h2><p>精度：Etag 要优于 Last-Modified。<br>性能：Last-Modified 要优于 Etag。<br>优先级：服务器校验优先考虑 Etag</p>
<h1 id="实际使用策略"><a href="#实际使用策略" class="headerlink" title="实际使用策略"></a>实际使用策略</h1><p>对与频繁变动的资源：<br>使用 Cache-Control: no-cache，使浏览器每次都请求服务器，然后配合 ETag 或者 Last-Modified 来验证资源是否有效。这样的做法虽然不能节省请求数量，但是能显著减少响应数据大小。</p>
<p>对于不常变化的资源：<br>通常在处理这类资源时，给它们的 Cache-Control 配置一个很大的 max-age&#x3D;31536000 (一年)，这样浏览器之后请求相同的 URL 会命中强制缓存。而为了解决更新的问题，就需要在文件名(或者路径)中添加 hash， 版本号等动态字符，之后更改动态字符，从而达到更改引用 URL 的目的，让之前的强制缓存失效 (其实并未立即失效，只是不再使用了而已)。</p>
<h1 id="用户行为如何触发缓存"><a href="#用户行为如何触发缓存" class="headerlink" title="用户行为如何触发缓存"></a>用户行为如何触发缓存</h1><p>打开网页，地址栏输入地址： 查找 disk cache 中是否有匹配。如有则使用；如没有则发送网络请求。<br>普通刷新 (F5)：因为 TAB 并没有关闭，因此 memory cache 是可用的，会被优先使用(如果匹配的话)。其次才是 disk cache。<br>强制刷新 (Ctrl + F5)：浏览器不使用缓存，因此发送的请求头部均带有 Cache-control: no-cache(为了兼容，还带了 Pragma: no-cache),服务器直接返回 200 和最新内容。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/54cc04190252">深入理解浏览器的缓存机制</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43972437/article/details/105513486">浏览器缓存：memory cache、disk cache、强缓存协商缓存等概念</a><br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/115243059">service worker 是什么？看这篇就够了</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://raezhang0822.github.io/2023/07/05/forEach%E5%92%8Cawait/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rae Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Welcome">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/05/forEach%E5%92%8Cawait/" class="post-title-link" itemprop="url">forEach与await引发的血案</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-05 06:31:53" itemprop="dateCreated datePublished" datetime="2023-07-05T06:31:53+00:00">2023-07-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><small>原文发布于 <a target="_blank" rel="noopener" href="https://blog.csdn.net/RaeZhang/article/details/117528885">CSDN</a>，本文系近期迁移，想看更多欢迎访问 <a target="_blank" rel="noopener" href="https://blog.csdn.net/RaeZhang?type=blog">我的 CSDN 主页</a></small></p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>前段时间在做需求的时候，遇到一个关于<code>forEach</code>和<code>await</code>的坑，记录一下。</p>
<p>在业务代码中存在一段很普通的同步循环逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleValueSync</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">list.<span class="title function_">forEach</span>(<span class="function">(<span class="params">value</span>) =&gt;</span> <span class="title function_">handleValueSync</span>(value));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 结果，1，2，3，4，5，6，7，8</span></span><br></pre></td></tr></table></figure>

<p>某一天，需求突然产生变化,原本同步的 handleValueSync 方法变成了异步的，所以我在原先代码基础上进行了简单的修改：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleValueAsync</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (value % <span class="number">2</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>];</span><br><span class="line"></span><br><span class="line">list.<span class="title function_">forEach</span>(<span class="keyword">async</span> (value) =&gt; <span class="keyword">await</span> <span class="title function_">handleValueAsync</span>(value));</span><br></pre></td></tr></table></figure>

<p>预期: 每次循环时，一定会 <code>await handleValueAsync</code>结束，然后开始下一次循环。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 预期结果 1，2，3，4，5，6，7，8</span></span><br></pre></td></tr></table></figure>

<p>实际输出结果却是<br><img src="/./img/forEach/wrong.png" alt="image"><br>await 似乎并没有生效。<br>换成 map 和 reduce 试一下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">list.<span class="title function_">map</span>(<span class="keyword">async</span> (value) =&gt; <span class="keyword">await</span> <span class="title function_">handleValueAsync</span>(value));</span><br><span class="line"></span><br><span class="line">list.<span class="title function_">reduce</span>(<span class="keyword">async</span> (&#123;&#125;, value) =&gt; <span class="keyword">await</span> <span class="title function_">handleValueAsync</span>(value), &#123;&#125;);</span><br></pre></td></tr></table></figure>

<p>也都是同样的结果<br><img src="/./img/forEach/wrong2.png" alt="image"></p>
<h2 id="怎样使得-await-生效"><a href="#怎样使得-await-生效" class="headerlink" title="怎样使得 await 生效"></a>怎样使得 await 生效</h2><p>网上搜索了一番，发现<code>forEach</code>就是不能支持异步调用，解决这个方法就是将 forEach 方法换成普通 for 循环就可以了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">handleValueAsync</span>(<span class="params">value</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (value % <span class="number">2</span> === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">awaitLoop</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.<span class="property">length</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">await</span> <span class="title function_">handleValueAsync</span>(list[i]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="title function_">awaitLoop</span>();</span><br></pre></td></tr></table></figure>

<p>结果<br><img src="/./img/forEach/right.png" alt="image"></p>
<p>这下就对了。。</p>
<h2 id="Why？"><a href="#Why？" class="headerlink" title="Why？"></a>Why？</h2><p>为什么 forEach 无法支持 await，而 for 循环可以呢？<br>搜了一下 forEach 的实现原理，原来 forEach 是 es6 的新语法。</p>
<blockquote>
<p>forEach() 是在第五版本里被添加到 ECMA-262 标准的；这样它可能在标准的其他实现中不存在，你可以在你调用 forEach() 之前插入下面的代码，在本地不支持的情况下使用 forEach()。</p>
<p>看下 MDN 上的<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Array/forEach">forEach 的 pollyfill 源码</a></p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Production steps of ECMA-262, Edition 5, 15.4.4.18</span></span><br><span class="line"><span class="comment">// Reference: http://es5.github.io/#x15.4.4.18</span></span><br><span class="line"><span class="keyword">if</span> (!<span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span>) &#123;</span><br><span class="line">  <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">forEach</span> = <span class="keyword">function</span> (<span class="params">callback, thisArg</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> T, k;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span> == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(<span class="string">&quot; this is null or not defined&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. Let O be the result of calling toObject() passing the</span></span><br><span class="line">    <span class="comment">// |this| value as the argument.</span></span><br><span class="line">    <span class="keyword">var</span> O = <span class="title class_">Object</span>(<span class="variable language_">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. Let lenValue be the result of calling the Get() internal</span></span><br><span class="line">    <span class="comment">// method of O with the argument &quot;length&quot;.</span></span><br><span class="line">    <span class="comment">// 3. Let len be toUint32(lenValue).</span></span><br><span class="line">    <span class="keyword">var</span> len = O.<span class="property">length</span> &gt;&gt;&gt; <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 4. If isCallable(callback) is false, throw a TypeError exception.</span></span><br><span class="line">    <span class="comment">// See: http://es5.github.com/#x9.11</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> callback !== <span class="string">&quot;function&quot;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TypeError</span>(callback + <span class="string">&quot; is not a function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 5. If thisArg was supplied, let T be thisArg; else let</span></span><br><span class="line">    <span class="comment">// T be undefined.</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">arguments</span>.<span class="property">length</span> &gt; <span class="number">1</span>) &#123;</span><br><span class="line">      T = thisArg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 6. Let k be 0</span></span><br><span class="line">    k = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 7. Repeat, while k &lt; len</span></span><br><span class="line">    <span class="keyword">while</span> (k &lt; len) &#123;</span><br><span class="line">      <span class="keyword">var</span> kValue;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// a. Let Pk be ToString(k).</span></span><br><span class="line">      <span class="comment">//    This is implicit for LHS operands of the in operator</span></span><br><span class="line">      <span class="comment">// b. Let kPresent be the result of calling the HasProperty</span></span><br><span class="line">      <span class="comment">//    internal method of O with argument Pk.</span></span><br><span class="line">      <span class="comment">//    This step can be combined with c</span></span><br><span class="line">      <span class="comment">// c. If kPresent is true, then</span></span><br><span class="line">      <span class="keyword">if</span> (k <span class="keyword">in</span> O) &#123;</span><br><span class="line">        <span class="comment">// i. Let kValue be the result of calling the Get internal</span></span><br><span class="line">        <span class="comment">// method of O with argument Pk.</span></span><br><span class="line">        kValue = O[k];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ii. Call the Call internal method of callback with T as</span></span><br><span class="line">        <span class="comment">// the this value and argument list containing kValue, k, and O.</span></span><br><span class="line">        callback.<span class="title function_">call</span>(T, kValue, k, O);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// d. Increase k by 1.</span></span><br><span class="line">      k++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 8. return undefined</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>简化一下，其实 <code>forEach</code>就是通过<code>while</code>循环多次执行 callback，相当于在 for 循环中执行了异步函数,<code>forEach</code>可以看成是这样</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.<span class="property">length</span>; i++) &#123;</span><br><span class="line">  (<span class="keyword">async</span> <span class="keyword">function</span> (<span class="params">value</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (value % <span class="number">2</span> === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="title class_">Promise</span>.<span class="title function_">resolve</span>().<span class="title function_">then</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;value&#125;</span>`</span>);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(value);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)(list[i]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以<code>await</code>不起作用</p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_33725239/article/details/91390618">当 async&#x2F;await 遇到 map 和 reduce</a><br><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chrissong/p/11247827.html">forEach 和 await&#x2F;async 的问题</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yumikobu/article/details/84639025">在 foreach 中使用 async&#x2F;await 的问题</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://raezhang0822.github.io/2023/07/05/hexo/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rae Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Welcome">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/05/hexo/" class="post-title-link" itemprop="url">Github Pages部署Hexo 踩坑记录</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-05 06:31:53" itemprop="dateCreated datePublished" datetime="2023-07-05T06:31:53+00:00">2023-07-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><p>这篇博客主要内容</p>
<ol>
<li>使用 Hexo（默认主题） 搭建 Github Pages 的过程并使用 Github Actions 实现自动部署</li>
<li>使用主题后自动部署出错及修复的过程</li>
</ol>
<h2 id="Hexo-基本使用和自动部署过程"><a href="#Hexo-基本使用和自动部署过程" class="headerlink" title="Hexo 基本使用和自动部署过程"></a>Hexo 基本使用和自动部署过程</h2><p>hexo 的基本使用参考 <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">官方文档</a><br>使用 GitHub Actions 部署至 GitHub Pages 参考 <a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/github-pages.html">在 GitHub Pages 上部署 Hexo</a></p>
<p>按照上述两个官方文档，可以顺利将默认主题的 Hexo 部署到 GitHub pages.<br>说明下，这种方式只用了一个 <code>username.github.io</code>仓库，main 分支上是 hexo 的源代码，gh-pages 分支上是 hexo 生成的文件。<br>配置的 workflow 可以实现:当 main 分支上有 push 时，重新执行 build 命令,将 public 文件下的内容创建一次 commit 然后 push 到 gh-pages 分支。<br><img src="/./img/hexo/branches.png" alt="image"></p>
<h2 id="Hexo-使用主题后自动部署失败踩坑记录"><a href="#Hexo-使用主题后自动部署失败踩坑记录" class="headerlink" title="Hexo 使用主题后自动部署失败踩坑记录"></a>Hexo 使用主题后自动部署失败踩坑记录</h2><h3 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h3><h4 id="主题安装"><a href="#主题安装" class="headerlink" title="主题安装"></a>主题安装</h4><p>以 <a target="_blank" rel="noopener" href="https://github.com/klugjo/hexo-theme-clean-blog.git">clean-blog 主题</a> 为例子<br>在项目根目录下执行</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone <span class="attr">https</span>:<span class="comment">//github.com/klugjo/hexo-theme-clean-blog.git themes/clean-blog</span></span><br></pre></td></tr></table></figure>

<p>将主题仓库 clone 到 themes 文件夹下</p>
<h4 id="设置主题"><a href="#设置主题" class="headerlink" title="设置主题"></a>设置主题</h4><p>在根目录下的<code>_config.yml</code> 文件中设置</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">theme</span>: ”clean-blog“; <span class="comment">// 注意与themes文件夹下的主题文件夹同名</span></span><br></pre></td></tr></table></figure>

<h4 id="部署出错"><a href="#部署出错" class="headerlink" title="部署出错"></a>部署出错</h4><p>可以在本地预览一下是没有问题的，但是当我把这一个主题改动 push 到 main 分支后，站点页面空白了，查看 gh-pages 分支发现文件数量明显少了很多，想了一下应该是主题作为子仓库在云端时没有拉到相应的 github 仓库的代码，导致无法找到主题文件。</p>
<h3 id="解决思路"><a href="#解决思路" class="headerlink" title="解决思路"></a>解决思路</h3><p>既然是没有主题文件，我尝试修改 workflow, 在 build 前拉取主题文件仓库</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line">  <span class="comment"># 安装主题文件</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Theme</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">git@github.com:klugjo/hexo-theme-clean-blog.git</span> <span class="string">themes/clean-blog</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Deploy</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">peaceiris/actions-gh-pages@v3</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">github_token:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.GITHUB_TOKEN</span> <span class="string">&#125;&#125;</span></span><br><span class="line">    <span class="attr">publish_dir:</span> <span class="string">./public</span></span><br></pre></td></tr></table></figure>

<p>push 之后触发重新构建报错<br><img src="/./img/hexo/error.png" alt="image"></p>
<h4 id="错误原因"><a href="#错误原因" class="headerlink" title="错误原因"></a>错误原因</h4><blockquote>
<p>这是因为你的开发机器上的用户通常与特定的 GitHub 帐户关联，并且该帐户具有对私有仓库的访问权限，而 GitHub Actions 用户只能看到它所附属的仓库。</p>
</blockquote>
<blockquote>
<p>如今，与 GitHub 进行身份验证的最佳方式是使用部署密钥（Deploy Keys）。这是一组 SSH 密钥，可以为用户提供对特定仓库的只读访问权限（默认情况下）。</p>
</blockquote>
<p>所以需要重新生成一组 SSH 密钥。</p>
<h4 id="解决过程"><a href="#解决过程" class="headerlink" title="解决过程"></a>解决过程</h4><ol>
<li><p>生成新的 ssh-keys<br><img src="/./img/hexo/sshKeyGen.png" alt="deployKeys"></p>
</li>
<li><p>将公钥添加到 Deploy Keys<br><img src="/./img/hexo/deployKeys.png" alt="deployKeys"></p>
</li>
<li><p>将 私钥 添加到 username.github.io 仓库的 密钥中<br><img src="/./img/hexo/secretKey.png" alt="deployKeys"></p>
</li>
<li><p>在 workflow 中添加授权</p>
</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Dependencies</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">npm</span> <span class="string">install</span></span><br><span class="line"><span class="comment">#   授权</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Give</span> <span class="string">GitHub</span> <span class="string">Actions</span> <span class="string">access</span> <span class="string">to</span> <span class="string">hexo</span> <span class="string">theme</span> <span class="string">repo</span></span><br><span class="line">  <span class="attr">uses:</span> <span class="string">webfactory/ssh-agent@v0.7.0</span></span><br><span class="line">  <span class="attr">with:</span></span><br><span class="line">    <span class="attr">ssh-private-key:</span> <span class="string">$&#123;&#123;</span> <span class="string">secrets.SECRET_REPO_DEPLOY_KEY</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="comment"># 安装主题</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Theme</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">git@github.com:klugjo/hexo-theme-clean-blog.git</span> <span class="string">themes/clean-blog</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span></span><br><span class="line">  <span class="attr">run:</span> <span class="string">npm</span> <span class="string">run</span> <span class="string">build</span></span><br></pre></td></tr></table></figure>

<p>修改完之后重试，即可看到 CI 成功，页面成功部署。</p>
<p>顺便说明，这种问题只有在使用 <code>git pull</code>方式安装主题时会出现，如果使用 <code>npm install</code> 安装主题，则不会出现上面的问题。支持<code>npm install</code> 这种方式安装的主题有限，我最后选择了 <a target="_blank" rel="noopener" href="https://github.com/next-theme/hexo-theme-next">Next</a>, 简单快捷。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/">Hexo 官方文档</a><br><a target="_blank" rel="noopener" href="https://hexo.io/zh-cn/docs/github-pages.html">在 GitHub Pages 上部署 Hexo</a><br><a target="_blank" rel="noopener" href="https://adventures.michaelfbryan.com/posts/configuring-cargo-auth-in-github-actions/">GitHub Actions can’t access private repos? Here’s how to fix it</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://raezhang0822.github.io/2023/07/05/tuner/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rae Zhang">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Welcome">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Welcome">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/07/05/tuner/" class="post-title-link" itemprop="url">实现一个在线调音器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2023-07-05 06:31:53" itemprop="dateCreated datePublished" datetime="2023-07-05T06:31:53+00:00">2023-07-05</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><small>原文发布于 <a target="_blank" rel="noopener" href="https://blog.csdn.net/RaeZhang/article/details/113075391?spm=1001.2014.3001.5502">CSDN</a>，本文系近期迁移，想看更多欢迎访问 <a target="_blank" rel="noopener" href="https://blog.csdn.net/RaeZhang?type=blog">我的 CSDN 主页</a></small></p>
<p>本来想做一个网页版的调音器，在网上搜了一下，发现已经有人实现过了，但是自己对这个原理还是很感兴趣，所以参照人家的<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/4fd8779943c3">博客</a>和<a target="_blank" rel="noopener" href="https://github.com/qiuxiang/tuner">源码</a>，用 svelte 重新实现了,最终效果请看 <a href="https://raezhang0822.github.io/codes/tuner/app/index.html">演示</a></p>
<p>一般用的调音器都是表盘式的，工作原理就是设备听到声音，分析声音的频率，判断出音高之后在屏幕上显示出来，在这个过程中我们可能需要解决这些问题：</p>
<ol>
<li>获取设备麦克风权限</li>
<li>获取声音频率</li>
<li>将声音频率换算成音高</li>
<li>将当前声音最接近的音名显示到表盘中间，并用指针显示当前声音与该音名对应的声音之间的偏差。偏低则向左指，偏低则向右指。</li>
</ol>
<p>看下这个过程的代码实现。</p>
<h2 id="获取麦克风权限"><a href="#获取麦克风权限" class="headerlink" title="获取麦克风权限"></a>获取麦克风权限</h2><p>获取麦克风权限使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/MediaDevices/getUserMedia">navigator.mediaDevices.getUserMedia()</a> 这个 api,<br>它接受一个<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStreamConstraints">MediaStreamConstraints (en-US) </a>对象，指定了请求的媒体类型和相对应的参数。返回对象是一个 Promise.</p>
<p>这里只需要处理音频，所以参数传入<code>&#123;audio:true&#125;</code> 就可以</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">navigator.<span class="property">mediaDevices</span></span><br><span class="line">  .<span class="title function_">getUserMedia</span>(&#123; <span class="attr">audio</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">  .<span class="title function_">then</span>(handleStream)</span><br><span class="line">  .<span class="title function_">catch</span>(<span class="keyword">function</span> (<span class="params">error</span>) &#123;</span><br><span class="line">    <span class="title function_">alert</span>(error.<span class="property">name</span> + <span class="string">&quot;: &quot;</span> + error.<span class="property">message</span>);</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>获取到媒体流之后，要从中分析得到声音频率。</p>
<p>这里有一个坑，我把代码部署到服务器之后，发现无法获取到麦克风权限，控制台报错<br><img src="/./img/tuner/error.png" alt="image"></p>
<p><img src="/./img/tuner/note.png" alt="image"><br>发现必须使用 HTTPS 加密通信才能获取<code>getUserMedia()</code>，这个问题需要注意下。</p>
<h2 id="获取声音数据"><a href="#获取声音数据" class="headerlink" title="获取声音数据"></a>获取声音数据</h2><p>用来处理音频的 API 是<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AudioContext">AudioContext</a></p>
<blockquote>
<p>AudioContext 接口表示由链接在一起的音频模块构建的音频处理图，每个模块由一个 AudioNode 表示。音频上下文控制它包含的节点的创建和音频处理或解码的执行。在做任何其他操作之前，您需要创建一个 AudioContext 对象，因为所有事情都是在上下文中发生的。建议创建一个 AudioContext 对象并复用它，而不是每次初始化一个新的 AudioContext 对象，并且可以对多个不同的音频源和管道同时使用一个 AudioContext 对象。</p>
</blockquote>
<p>分析音频流需要使用 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/BaseAudioContext/createAnalyser">AudioContext.createAnalyser()</a></p>
<blockquote>
<p>AudioContext 的 createAnalyser()方法能创建一个 AnalyserNode，可以用来获取音频时间和频率数据，以及实现数据可视化。</p>
</blockquote>
<p>用 js 处理音频流需要用到<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/BaseAudioContext/createScriptProcessor">AudioContext.createScriptProcessor()</a></p>
<blockquote>
<p>AudioContext 接口的 createScriptProcessor() 方法创建一个 ScriptProcessorNode 用于通过 JavaScript 直接处理音频.</p>
</blockquote>
<p><code>scriptProcessor</code>是一个<a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/ScriptProcessorNode">ScriptProcessorNode</a></p>
<blockquote>
<p>ScriptProcessorNode 接口允许使用 JavaScript 生成、处理、分析音频. 它是一个 AudioNode， 连接着两个缓冲区音频处理模块, 其中一个缓冲区包含输入音频数据，另外一个包含处理后的输出音频数据. 实现了 AudioProcessingEvent (en-US) 接口的一个事件，每当输入缓冲区有新的数据时，事件将被发送到该对象，并且事件将在数据填充到输出缓冲区后结束.</p>
</blockquote>
<p>监听它的<code>audioprocess</code>事件就可以获得输入音频数据。</p>
<p>音频通路需要连接最终的目标节点<br><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/BaseAudioContext/destination">AudioContext.destination</a></p>
<blockquote>
<p>AudioContext 的 destination 属性返回一个 AudioDestinationNode 表示 context 中所有音频（节点）的最终目标节点，一般是音频渲染设备，比如扬声器。</p>
</blockquote>
<p>将以上几个节点依次连接起来</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取AudioContext实例</span></span><br><span class="line"><span class="keyword">const</span> audioContext = <span class="keyword">new</span> <span class="variable language_">window</span>.<span class="title class_">AudioContext</span>();</span><br><span class="line"><span class="comment">// 创建 analyser用来获取音频频率数据</span></span><br><span class="line"><span class="keyword">const</span> analyser = audioContext.<span class="title function_">createAnalyser</span>();</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">const</span> bufferSize = <span class="number">4096</span>;</span><br><span class="line"><span class="keyword">const</span> scriptProcessor = audioContext.<span class="title function_">createScriptProcessor</span>(bufferSize, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleStream</span> = (<span class="params">stream</span>) =&gt; &#123;</span><br><span class="line">  <span class="comment">// 创建MediaStreamAudioSourceNode</span></span><br><span class="line">  <span class="comment">// 把AudioBufferSourceNode连接到analyser</span></span><br><span class="line">  audioContext.<span class="title function_">createMediaStreamSource</span>(stream).<span class="title function_">connect</span>(analyser);</span><br><span class="line">  <span class="comment">// 将analyser连接到 scriptProcessor,用js处理</span></span><br><span class="line">  analyser.<span class="title function_">connect</span>(scriptProcessor);</span><br><span class="line">  <span class="comment">//将scriptProcessor与destination连接，这样才能形成到达扬声器的通路</span></span><br><span class="line">  scriptProcessor.<span class="title function_">connect</span>(audioContext.<span class="property">destination</span>);</span><br><span class="line">  scriptProcessor.<span class="title function_">addEventListener</span>(<span class="string">&quot;audioprocess&quot;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> data = event.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>); <span class="comment">// 获取到音频数据</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="计算声音频率"><a href="#计算声音频率" class="headerlink" title="计算声音频率"></a>计算声音频率</h2><blockquote>
<p>音高检测算法已经很成熟了，不乏论文和资料，诸如 java、c&#x2F;c++ 都有现成的库可用，而 js 在这方面显然是有缺失的。因为我的目的是快速实现一个调音器，所以我是基于一个现有的 c 音频库 aubio 用 emscripten 编译成 js，以便在浏览器里运行。</p>
</blockquote>
<p>这里将 c 语言的音频库转译成 js 涉及到<a target="_blank" rel="noopener" href="https://www.wasm.com.cn/">Web Assembluy</a>相关的知识。关于 Web Assembly,我也不是特别了解，以后有机会做一下实践。这里只需要了解下 Web Assembly 是做什么的就好。</p>
<p>简单来说，WebAssembly 是一种新的字节码格式，目前可以使用 C、C++、Rust、Go、Java、C#等编译器（未来还有更多）来创建 wasm 模块（见下图）。该模块以二进制的格式发送到浏览器，浏览器提供了专门的虚拟机环境来运行 wasm 的代码，与 JavaScript 虚拟机共享内存和线程等资源。</p>
<p>编译之后的 audio 库有两个文件，一个 audio.js 文件，一个 audio.wasm 文件。</p>
<p>通过这个库提供的方法，可以计算得到音频的频率</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> pitchDetector = <span class="literal">null</span>;</span><br><span class="line"><span class="title class_">Aubio</span>().<span class="title function_">then</span>(<span class="keyword">function</span> (<span class="params">aubio</span>) &#123;</span><br><span class="line">	<span class="comment">// 确保Aubio模块加载完毕之后使用</span></span><br><span class="line">  pitchDetector = <span class="keyword">new</span> aubio.<span class="title class_">Pitch</span>(<span class="string">&#x27;default&#x27;</span>, bufferSize, <span class="number">1</span>, audioContext.<span class="property">sampleRate</span>);</span><br><span class="line">  ...</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">handleStream</span> = (<span class="params">stream</span>) =&gt; &#123;</span><br><span class="line">  audioContext.<span class="title function_">createMediaStreamSource</span>(stream).<span class="title function_">connect</span>(analyser);</span><br><span class="line">  analyser.<span class="title function_">connect</span>(scriptProcessor);</span><br><span class="line">  scriptProcessor.<span class="title function_">connect</span>(audioContext.<span class="property">destination</span>);</span><br><span class="line">  scriptProcessor.<span class="title function_">addEventListener</span>(<span class="string">&#x27;audioprocess&#x27;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算获取频率</span></span><br><span class="line">    <span class="keyword">const</span> frequency = pitchDetector.<span class="title function_">do</span>(event.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>));</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="计算音名"><a href="#计算音名" class="headerlink" title="计算音名"></a>计算音名</h2><h3 id="关于音名"><a href="#关于音名" class="headerlink" title="关于音名"></a>关于音名</h3><p>传统音乐理论中使用前七个拉丁字母：A、B、C、D、E、F、G（按此顺序则音高循序而上）以及一些变化（升音和降音符号）来标示不同的音符。两个音符间若相差一倍的频率，则称两者之间相差一个八度。为了标示同名但不同高度的音符，科学音调记号法利用字母及一个用来表示所在八度的阿拉伯数字，明确指出音符的位置。比如说，现在的标准调音音高 440 赫兹名为 A4，往上高八度则为 A5，继续向上可无限延伸；至于 A4 往下，则为 A3、A2…等。</p>
<p>把音高频率转成对应的 MIDI 编号，对照即可找到音名，比如 82.41 Hz 计算得到 MIDI 编号 38，即数字法音名 E2。<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9F%B3%E7%AC%A6">维基百科-音符</a>里有详细的描述、公式及八度命名系统对照表格。<br><img src="/./img/tuner/p.png" alt="image"><br><img src="/./img/tuner/table.png" alt="image"></p>
<p>写成代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> middleA = <span class="number">440</span>;</span><br><span class="line"><span class="keyword">const</span> semitone = <span class="number">69</span>;</span><br><span class="line"><span class="keyword">const</span> getNote = <span class="keyword">function</span> (<span class="params">frequency</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> note = <span class="number">12</span> * (<span class="title class_">Math</span>.<span class="title function_">log</span>(frequency / middleA) / <span class="title class_">Math</span>.<span class="title function_">log</span>(<span class="number">2</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">round</span>(note) + semitone;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">scriptProcessor.<span class="title function_">addEventListener</span>(<span class="string">&quot;audioprocess&quot;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> frequency = pitchDetector.<span class="title function_">do</span>(event.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>));</span><br><span class="line">  <span class="keyword">if</span> (frequency) &#123;</span><br><span class="line">    <span class="keyword">const</span> note = <span class="title function_">getNote</span>(frequency);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="计算指针偏转"><a href="#计算指针偏转" class="headerlink" title="计算指针偏转"></a>计算指针偏转</h2><p>并不是每个声音的频率都恰好准确地等于音名的频率，大部分声音的频率会相对于音名有一定偏移量，<strong>音分</strong>是用来衡量音高偏移的单位。</p>
<p>在十二平均律中，将一个八度音程分为 12 个半音。每一个半音的音程（相当于相邻钢琴键间的音程）等于 100 音分。相差一个八度的两个音之间的音程总共是 1200 音分。</p>
<p>12 个音名分别是</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> noteStrings = [</span><br><span class="line">  <span class="string">&quot;C&quot;</span>,</span><br><span class="line">  <span class="string">&quot;C♯&quot;</span>,</span><br><span class="line">  <span class="string">&quot;D&quot;</span>,</span><br><span class="line">  <span class="string">&quot;D♯&quot;</span>,</span><br><span class="line">  <span class="string">&quot;E&quot;</span>,</span><br><span class="line">  <span class="string">&quot;F&quot;</span>,</span><br><span class="line">  <span class="string">&quot;F♯&quot;</span>,</span><br><span class="line">  <span class="string">&quot;G&quot;</span>,</span><br><span class="line">  <span class="string">&quot;G♯&quot;</span>,</span><br><span class="line">  <span class="string">&quot;A&quot;</span>,</span><br><span class="line">  <span class="string">&quot;A♯&quot;</span>,</span><br><span class="line">  <span class="string">&quot;B&quot;</span>,</span><br><span class="line">];</span><br></pre></td></tr></table></figure>

<p>每两个音名之间的差距为 100 音分，用音分来计算声音相对最近的音名的偏移量，并用来计算指针旋转角度。</p>
<p>下面是计算音分的方法，其计算公式详细可以去看<a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/%E9%9F%B3%E5%88%86">维基百科-音分</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> getStandardFrequency = <span class="keyword">function</span> (<span class="params">note</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> middleA * <span class="title class_">Math</span>.<span class="title function_">pow</span>(<span class="number">2</span>, (note - semitone) / <span class="number">12</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> getCents = <span class="keyword">function</span> (<span class="params">frequency, note</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="title class_">Math</span>.<span class="title function_">floor</span>(</span><br><span class="line">    (<span class="number">1200</span> * <span class="title class_">Math</span>.<span class="title function_">log</span>(frequency / <span class="title function_">getStandardFrequency</span>(note))) / <span class="title class_">Math</span>.<span class="title function_">log</span>(<span class="number">2</span>)</span><br><span class="line">  );</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>完整的代码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> onNoteDetected = <span class="keyword">function</span> (<span class="params">note</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; value, cents, frequency &#125; = note;</span><br><span class="line">  curValue = value;</span><br><span class="line">  curDeg = (cents / <span class="number">50</span>) * <span class="number">45</span>; <span class="comment">// 计算得到旋转角度</span></span><br><span class="line">  curFrq = frequency;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">scriptProcessor.<span class="title function_">addEventListener</span>(<span class="string">&quot;audioprocess&quot;</span>, <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> frequency = pitchDetector.<span class="title function_">do</span>(event.<span class="property">inputBuffer</span>.<span class="title function_">getChannelData</span>(<span class="number">0</span>));</span><br><span class="line">  <span class="keyword">if</span> (frequency &amp;&amp; onNoteDetected) &#123;</span><br><span class="line">    <span class="keyword">const</span> note = <span class="title function_">getNote</span>(frequency);</span><br><span class="line">    <span class="title function_">onNoteDetected</span>(&#123;</span><br><span class="line">      <span class="attr">name</span>: noteStrings[note % <span class="number">12</span>],</span><br><span class="line">      <span class="attr">value</span>: note,</span><br><span class="line">      <span class="attr">cents</span>: <span class="title function_">getCents</span>(frequency, note),</span><br><span class="line">      <span class="attr">octave</span>: <span class="built_in">parseInt</span>(note / <span class="number">12</span>) - <span class="number">1</span>,</span><br><span class="line">      <span class="attr">frequency</span>: frequency,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h2 id="表盘实现"><a href="#表盘实现" class="headerlink" title="表盘实现"></a>表盘实现</h2><p>通过上面的计算我们已经获得了当前频率、当前音名与指针需要偏转的角度，表盘的实现部分就比较简单了，直接贴代码看一下。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">// 刻度盘与指针</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">export</span> <span class="keyword">let</span> deg = <span class="number">0</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> arr = <span class="title class_">Array</span>.<span class="title function_">from</span>(<span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">11</span>).<span class="title function_">keys</span>());</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;meter&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;meter-dot&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;meter-pointer&quot;</span> <span class="attr">style</span>=<span class="string">&#123;</span>`<span class="attr">transform:rotate</span>($&#123;<span class="attr">deg</span>&#125;<span class="attr">deg</span>)`&#125;&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;#each arr as i&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class:meter-scale</span>=<span class="string">&#123;true&#125;</span> <span class="attr">class:meter-scale-strong</span> = <span class="string">&#123;i</span> % <span class="attr">5</span> === <span class="string">0</span> &#125; <span class="attr">style</span>=<span class="string">&#123;</span>`<span class="attr">transform:rotate</span>($&#123;<span class="attr">i</span> * <span class="attr">9</span> <span class="attr">-</span> <span class="attr">45</span>&#125;<span class="attr">deg</span>)`&#125;&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;/each&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.meter</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">position</span>: fixed;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">left</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">right</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">bottom</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">width</span>: <span class="number">400px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">height</span>: <span class="number">33%</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">margin</span>: <span class="number">0</span> auto <span class="number">5vh</span> auto;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.meter-pointer</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">width</span>: <span class="number">2px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#2c3e50</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">transform</span>: <span class="built_in">rotate</span>(<span class="number">45deg</span>);</span></span><br><span class="line"><span class="language-css">  <span class="attribute">transform-origin</span>: bottom;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">transition</span>: transform <span class="number">0.5s</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">right</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.meter-dot</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">width</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">height</span>: <span class="number">10px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">background</span>: <span class="number">#2c3e50</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">border-radius</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">bottom</span>: -<span class="number">5px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">right</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">margin-right</span>: -<span class="number">4px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.meter-scale</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">width</span>: <span class="number">1px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">height</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">transform-origin</span>: bottom;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">transition</span>: transform <span class="number">0.2s</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">box-sizing</span>: border-box;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">border-top</span>: <span class="number">10px</span> solid;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">position</span>: absolute;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">right</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-class">.meter-scale-strong</span> &#123;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">width</span>: <span class="number">2px</span>;</span></span><br><span class="line"><span class="language-css">  <span class="attribute">border-top-width</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">import</span> <span class="title class_">Note</span> <span class="keyword">from</span> <span class="string">&quot;./Note.svelte&quot;</span>;</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">let</span> value; <span class="comment">//当前检测到的MIDI编号</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">let</span> frequency; <span class="comment">//当前频率</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">export</span> <span class="keyword">let</span> nodeList; <span class="comment">// node列表的dom节点</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> octaveList = [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>];</span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> noteStrings = [</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;C&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;C♯&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;D&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;D♯&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;E&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;F&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;F♯&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;G&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;G♯&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;A&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;A♯&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">    <span class="string">&quot;B&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">  ];</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">const</span> <span class="title function_">handleActive</span> = (<span class="params">e</span>) =&gt; &#123;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> dom = e.<span class="property">detail</span>;</span></span><br><span class="line"><span class="language-javascript">    nodeList.<span class="property">scrollLeft</span> =</span></span><br><span class="line"><span class="language-javascript">      dom.<span class="property">offsetLeft</span> - (nodeList.<span class="property">clientWidth</span> - dom.<span class="property">clientWidth</span>) / <span class="number">2</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-class">.notes</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">margin</span>: auto;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">width</span>: <span class="number">400px</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">position</span>: fixed;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">top</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">left</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">right</span>: <span class="number">0</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">text-align</span>: center;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css">  <span class="selector-class">.notes-list</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">overflow</span>: auto;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">overflow</span>: -moz-scrollbars-none;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">white-space</span>: nowrap;</span></span><br><span class="line"><span class="language-css">    -ms-<span class="attribute">overflow</span>-style: none;</span></span><br><span class="line"><span class="language-css">    -webkit-<span class="attribute">mask-image</span>: <span class="built_in">-webkit-linear-gradient</span>(</span></span><br><span class="line"><span class="language-css">      left,</span></span><br><span class="line"><span class="language-css">      <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>),</span></span><br><span class="line"><span class="language-css">      <span class="number">#fff</span>,</span></span><br><span class="line"><span class="language-css">      <span class="built_in">rgba</span>(<span class="number">255</span>, <span class="number">255</span>, <span class="number">255</span>, <span class="number">0</span>)</span></span><br><span class="line"><span class="language-css">    );</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-class">.frequency</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-size</span>: <span class="number">32px</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-class">.frequency</span> <span class="selector-tag">span</span> &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">font-size</span>: <span class="number">50%</span>;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">margin-left</span>: <span class="number">0.25em</span>;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="selector-class">.notes-list</span>::-webkit-scrollbar &#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">display</span>: none;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span></span><br><span class="line"><span class="language-css">  <span class="keyword">@media</span> (<span class="attribute">max-width</span>: <span class="number">768px</span>) &#123;</span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.notes</span> &#123;</span></span><br><span class="line"><span class="language-css">      <span class="attribute">width</span>: <span class="number">100%</span>;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css">  &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;notes&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;notes-list&quot;</span> <span class="attr">bind:this</span>=<span class="string">&quot;&#123;nodeList&#125;&quot;</span>&gt;</span></span><br><span class="line">    &#123;#each octaveList as octave&#125; &#123;#each noteStrings as note, index&#125; <span class="tag">&lt;<span class="name">Note</span></span></span><br><span class="line"><span class="tag">    <span class="attr">note</span>=<span class="string">&#123;note&#125;</span> <span class="attr">octave</span>=<span class="string">&#123;octave&#125;</span> <span class="attr">isActive</span>=<span class="string">&#123;value</span> === <span class="string">12*(octave+1)+index&#125;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">listDom</span>=<span class="string">&#123;nodeList&#125;</span> <span class="attr">on:onActive</span>=<span class="string">&#123;handleActive&#125;/</span>&gt;</span> &#123;/each&#125; &#123;/each&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;frequency&quot;</span>&gt;</span>&#123;frequency.toFixed(2)&#125;<span class="tag">&lt;<span class="name">span</span>&gt;</span>Hz<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>以上就是代码的核心部分。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Rae Zhang</span>
</div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
